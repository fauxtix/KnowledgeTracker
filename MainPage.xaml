<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:KnowledgeTracker.Converters"
             x:Class="KnowledgeTracker.MainPage"
             Title="Knowledge Tracker"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <Grid Padding="20" ColumnSpacing="20" RowSpacing="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="1*" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <!-- Header -->
        <Label Grid.Row="0" Grid.ColumnSpan="2"
              Text="Knowledge Tracker"
              FontSize="32"
              FontAttributes="Bold"
              HorizontalOptions="Center"
              VerticalOptions="Center"
              TextColor="{DynamicResource AccentColor}"
              Margin="0,0,0,10" />
        <ImageButton Grid.Row="0" Grid.Column="1"
             Command="{Binding ToggleThemeCommand}"
             Source="{Binding ThemeSwitchIcon}"
             BackgroundColor="Transparent"
             HeightRequest="32"
             WidthRequest="32"
             HorizontalOptions="End"
             VerticalOptions="Center"
             Margin="0,0,0,10" />
        <SearchBar x:Name="searchBar"
                   Grid.Row="1" Grid.Column="0"
                   Placeholder="Pesquisar..."
                   SearchCommand="{Binding SearchCommand}"
                   SearchCommandParameter="{Binding Text, Source={x:Reference searchBar}}"
                   BackgroundColor="{DynamicResource StackBackgroundColor}"
                   TextColor="{DynamicResource LabelTextColor}"
                   PlaceholderColor="#888"
                   CancelButtonColor="{DynamicResource LabelTextColor}" />

        <VerticalStackLayout Grid.Row="2" Grid.Column="0" Spacing="10" 
                             BackgroundColor="{DynamicResource StackBackgroundColor}">
            <CollectionView ItemsSource="{Binding Entries}"
                SelectedItem="{Binding SelectedEntry}"
                SelectionMode="Single"
                Margin="5,20,5,0"
                BackgroundColor="{DynamicResource StackBackgroundColor}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BorderColor="#B2BEB5"
                           CornerRadius="5" 
                           Padding="10,10,10,10"
                           Margin="0,10,0,5"                                
                           HasShadow="True"
                           BackgroundColor="{DynamicResource FrameBackgroundColor}">
                    <Label Text="{Binding Title}"
                            FontAttributes="Bold"
                            TextColor="{DynamicResource LabelTextColor}"
                            LineBreakMode="WordWrap"
                            VerticalOptions="Start"
                            HorizontalOptions="FillAndExpand" />
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <CollectionView ItemsSource="{Binding ValidationErrors}" 
                        IsVisible="{Binding HasValidationErrors}"
                        Margin="0,10,0,0"
                        BackgroundColor="{DynamicResource ErrorBackgroundColor}"
                        SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="{DynamicResource ErrorBackgroundColor}" Padding="5" Margin="2" CornerRadius="4" HasShadow="False">
                            <Label Text="{Binding .}" TextColor="{DynamicResource ErrorTextColor}" FontAttributes="Bold" />
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Button Text="Fechar"
                    IsVisible="{Binding HasValidationErrors}"
                    Command="{Binding ClearValidationErrorsCommand}"
                    BackgroundColor="SteelBlue"
                    TextColor="White"
                    FontAttributes="Bold"
                    Margin="0,5,0,0"
                    HorizontalOptions="End"/>
        </VerticalStackLayout>

        <Grid Grid.Row="2" Grid.Column="1" RowDefinitions="*,Auto" Margin="20, 0,20, 0">
            <ScrollView Grid.Row="0">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Título" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Entry Text="{Binding SelectedEntry.Title}" Style="{StaticResource EntryStyle}" Placeholder="Digite o título..." />

                    <Label Text="Descrição" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Editor Text="{Binding SelectedEntry.Description}" Style="{StaticResource EditorStyle}" Placeholder="Descrição detalhada..." />

                    <Label Text="Nome do Projeto" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Entry Text="{Binding SelectedEntry.ProjectName}" Style="{StaticResource EntryStyle}" Placeholder="Nome do projeto..." />

                    <Label Text="Tecnologias" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Entry Text="{Binding SelectedEntry.Technologies}" Style="{StaticResource EntryStyle}" Placeholder="Tecnologias utilizadas..." />

                    <Label Text="Tags" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Entry Text="{Binding SelectedEntry.Tags}" Style="{StaticResource EntryStyle}" Placeholder="Tags separadas por vírgula..." />

                    <Label Text="URL do vídeo do YouTube:" TextColor="{DynamicResource AccentColor}" />
                    <Entry Text="{Binding SelectedEntry.YouTubeUrl}" 
                           Placeholder="Cole a URL do YouTube aqui"
                           Style="{StaticResource EntryStyle}" />

                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                        <Button Text="Exibir Vídeo"
                                Command="{Binding ShowYouTubeVideoCommand}"
                                Style="{StaticResource ButtonStyle}" />

                        <Button Text="Ver no YouTube"
                                Command="{Binding OpenYouTubeInBrowserCommand}"
                                Style="{StaticResource ButtonStyle}" />
                    </HorizontalStackLayout>
                    <WebView Source="{Binding YouTubeHtmlSource}"
                             IsVisible="{Binding IsYouTubeVisible}"
                             HeightRequest="300"
                             WidthRequest="400"
                             HorizontalOptions="Center"
                             VerticalOptions="Center" />

                    <Label Text="Passos da Resolução" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Editor Text="{Binding SelectedEntry.ResolutionSteps}" Style="{StaticResource CodeEditorStyle}" Placeholder="Cole ou digite o código/steps aqui..." />

                    <Label Text="Notas" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <Editor Text="{Binding SelectedEntry.Comments}" Style="{StaticResource CodeEditorStyle}" Placeholder="Comentários adicionais..." />

                    <Label Text="Data da Resolução" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}" />
                    <DatePicker  Date="{Binding SelectedEntry.DateResolved, Converter={StaticResource NullableDateTimeToDateTimeConverter}}" 
                                 Format="dd/MM/yyyy"
                                 TextColor="{DynamicResource DatePickerTextColor}"
                                 BackgroundColor="{DynamicResource DatePickerBackgroundColor}" />
                </VerticalStackLayout>
            </ScrollView>

            <HorizontalStackLayout Grid.Row="1" Spacing="10" HorizontalOptions="Center" Margin="0,20,0,0">
                <Button Text="Limpar"
                        Command="{Binding NewEntryCommand}"
                        IsEnabled="{Binding SelectedEntry.Id, Converter={StaticResource GreaterThanZeroConverter}, ConverterParameter=invert}"
                        Style="{StaticResource ButtonNovoStyle}"
                        ImageSource="clear.png"
                        ContentLayout="Left,10" />
                <Button Text="Adicionar"
                        Command="{Binding AddCommand}"
                        IsEnabled="{Binding SelectedEntry.Id, Converter={StaticResource GreaterThanZeroConverter}, ConverterParameter=invert}"
                        Style="{StaticResource ButtonAdicionarStyle}"
                        ImageSource="add.png"
                        ContentLayout="Left,10" />

                <Button 
                    Text="Atualizar"
                    Command="{Binding UpdateCommand}"
                    IsEnabled="{Binding SelectedEntry.Id, Converter={StaticResource GreaterThanZeroConverter}}"
                    Style="{StaticResource ButtonAtualizarStyle}"
                    ImageSource="update.png"
                    ContentLayout="Left,10" />

                <Button Text="Excluir"
                        Command="{Binding DeleteCommand}"
                        IsEnabled="{Binding SelectedEntry.Id, Converter={StaticResource GreaterThanZeroConverter}}"
                        Style="{StaticResource ButtonExcluirStyle}"
                        ImageSource="delete.png"
                        ContentLayout="Left,10" />
            </HorizontalStackLayout>
        </Grid>
    </Grid>
</ContentPage>